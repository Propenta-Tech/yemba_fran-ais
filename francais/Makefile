# Makefile pour compilateur FRANÃ‡AIS exo20-23
CC = gcc
CFLAGS = -Wall -Wextra -Wno-unused-function
BISON = bison
FLEX = flex
NASM = nasm
LD = ld

# Fichiers source (mÃªmes noms)
YACC_FILE = exo20-23.y
LEX_FILE = exo20-23.lex

# Fichiers gÃ©nÃ©rÃ©s
YACC_C = exo20-23.c
YACC_H = simple.h
LEX_C = exo20-23.yy.c

# ExÃ©cutable
COMPILER = exo20-23

# Cible principale
all: test

# Compilation du compilateur FRANÃ‡AIS
$(COMPILER): $(YACC_FILE) $(LEX_FILE)
	@echo "ğŸ‡«ğŸ‡· GÃ©nÃ©ration du parser FRANÃ‡AIS avec Bison..."
	$(BISON) --defines=$(YACC_H) -v -o $(YACC_C) $(YACC_FILE)
	@echo "ğŸ” GÃ©nÃ©ration du lexer FRANÃ‡AIS avec Flex..."
	$(FLEX) -o $(LEX_C) $(LEX_FILE)
	@echo "ğŸ”¨ Compilation du compilateur FRANÃ‡AIS..."
	$(CC) $(CFLAGS) $(LEX_C) $(YACC_C) -o $(COMPILER) -lfl
	@echo "âœ… Compilateur FRANÃ‡AIS $(COMPILER) crÃ©Ã©"

# Test simple franÃ§ais
test-simple: $(COMPILER)
	@echo "ğŸ§ª Test simple FRANÃ‡AIS..."
	@echo "a = 5; afficher a;" | ./$(COMPILER)
	@if [ -f programme.asm ]; then \
		echo "âœ… Code assembleur gÃ©nÃ©rÃ©"; \
		echo "âš™ï¸  Assemblage..."; \
		$(NASM) -f elf -o test.o programme.asm || exit 1; \
		echo "ğŸ”— Liaison..."; \
		$(LD) -s -o test test.o -melf_i386 -I/lib/ld-linux.so.2 -lc || exit 1; \
		echo "âœ… Test FRANÃ‡AIS rÃ©ussi !"; \
	else \
		echo "âŒ Aucun fichier assembleur gÃ©nÃ©rÃ©"; \
	fi

# GÃ©nÃ©ration du programme assembleur FRANÃ‡AIS
programme.asm: $(COMPILER) commande.mes
	@echo "ğŸ¤– Compilation du programme FRANÃ‡AIS commande.mes..."
	cat commande.mes | ./$(COMPILER)
	@if [ $$? -eq 0 ]; then \
		echo "âœ… Code assembleur FRANÃ‡AIS gÃ©nÃ©rÃ©"; \
	else \
		echo "âŒ Erreur dans la compilation FRANÃ‡AISE"; \
		exit 1; \
	fi

# Assemblage
test.o: programme.asm
	@echo "âš™ï¸  Assemblage avec NASM..."
	$(NASM) -f elf -o test.o programme.asm

# Liaison
test: test.o
	@echo "ğŸ”— Liaison pour crÃ©er l'exÃ©cutable..."
	$(LD) -s -o test test.o -melf_i386 -I/lib/ld-linux.so.2 -lc
	@echo "âœ… ExÃ©cutable 'test' FRANÃ‡AIS crÃ©Ã© avec succÃ¨s"

# Test complet avec exÃ©cution
run: test
	@echo "ğŸƒ ExÃ©cution du programme FRANÃ‡AIS :"
	@echo "===================================="
	./test
	@echo "===================================="
	@echo "âœ… ExÃ©cution FRANÃ‡AISE terminÃ©e"

# Diagnostic des mots-clÃ©s franÃ§ais
test-mots-cles: $(COMPILER)
	@echo "ğŸ‡«ğŸ‡· Tests des mots-clÃ©s FRANÃ‡AIS :"
	@echo "=================================="
	@echo ""
	@echo "ğŸ§ª 1. Test AFFICHER :"
	@echo "a = 5; afficher a;" | ./$(COMPILER)
	@echo ""
	@echo "ğŸ§ª 2. Test SI-SINON :"
	@echo "a = 5; si (a > 3) alors afficher a; sinon afficher 0; fsi" | ./$(COMPILER)
	@echo ""
	@echo "ğŸ§ª 3. Test POUR :"
	@echo "pour i = 1 jusqua 3 afficher i; suivant;" | ./$(COMPILER)
	@echo ""
	@echo "ğŸ§ª 4. Test TANTQUE :"
	@echo "c = 2; tantque (c > 0) faire afficher c; c = c - 1; fait" | ./$(COMPILER)
	@echo ""
	@echo "ğŸ§ª 5. Test SELON :"
	@echo "a = 1; selon (a) { cas 1: afficher 100; arreter; defaut: afficher 999; }" | ./$(COMPILER)

# Comparaison anglais/franÃ§ais
compare-langues:
	@echo "ğŸ‡¬ğŸ‡§ğŸ‡«ğŸ‡· COMPARAISON ANGLAIS vs FRANÃ‡AIS :"
	@echo "=========================================="
	@echo "ANGLAIS          â†’  FRANÃ‡AIS"
	@echo "--------         â†’  --------"
	@echo "if               â†’  si"
	@echo "then             â†’  alors"  
	@echo "else             â†’  sinon"
	@echo "fi               â†’  fsi"
	@echo "for              â†’  pour"
	@echo "to               â†’  jusqua"
	@echo "next             â†’  suivant"
	@echo "step             â†’  pas"
	@echo "while            â†’  tantque"
	@echo "do               â†’  faire"
	@echo "done             â†’  fait"
	@echo "switch           â†’  selon"
	@echo "case             â†’  cas"
	@echo "default          â†’  defaut"
	@echo "break            â†’  arreter"
	@echo "print            â†’  afficher"
	@echo "read             â†’  lire"
	@echo ""
	@echo "ğŸ¯ Syntaxe FRANÃ‡AISE complÃ¨te supportÃ©e !"

# Test avec entrÃ©es automatiques
test-auto: test
	@echo "ğŸ¤– Test automatique FRANÃ‡AIS avec entrÃ©es prÃ©dÃ©finies..."
	@echo -e "25\n3\n42" | ./test

# Diagnostic des conflits
check-conflicts: $(YACC_FILE)
	@echo "ğŸ” VÃ©rification des conflits de grammaire..."
	$(BISON) --defines=$(YACC_H) -v -o $(YACC_C) $(YACC_FILE)
	@if [ -f exo20-23.output ]; then \
		echo "ğŸ“‹ Analyse des conflits :"; \
		grep -A 5 -B 5 "conflict" exo20-23.output || echo "âœ… Aucun conflit dÃ©tectÃ©"; \
	fi

# Analyse du code assembleur
analyse-asm: programme.asm
	@echo "ğŸ” Analyse du code assembleur gÃ©nÃ©rÃ© :"
	@echo "======================================"
	@echo "ğŸ“Š Structure du programme :"
	@grep -n "section\|global\|_start\|while_\|for_\|if_\|endif_" programme.asm || echo "Pas de structures complexes"
	@echo ""
	@echo "ğŸ“Š Labels gÃ©nÃ©rÃ©s :"
	@grep -n "^[a-zA-Z_][a-zA-Z0-9_]*:" programme.asm || echo "Pas de labels"

# Tests par Ã©tapes FRANÃ‡AIS
test-steps: $(COMPILER)
	@echo "ğŸ”„ Tests par Ã©tapes FRANÃ‡AIS :"
	@echo "=============================="
	@echo ""
	@echo "ğŸ§ª 1. Test expressions simples :"
	@echo "a = 5; b = 3; afficher a + b;" | ./$(COMPILER)
	@echo ""
	@echo "ğŸ§ª 2. Test SI simple :"
	@echo "a = 5; si (a > 3) alors afficher a; fsi" | ./$(COMPILER)
	@echo ""
	@echo "ğŸ§ª 3. Test POUR simple :"
	@echo "pour i = 1 jusqua 3 afficher i; suivant;" | ./$(COMPILER)

# Nettoyage
clean:
	@echo "ğŸ§¹ Nettoyage..."
	rm -f $(YACC_C) $(YACC_H) $(LEX_C)
	rm -f exo20-23.output
	rm -f programme.asm test.o test
	rm -f $(COMPILER)

# Nettoyage partiel (garde le compilateur)
clean-temp:
	@echo "ğŸ§¹ Nettoyage temporaire..."
	rm -f programme.asm test.o test
	rm -f exo20-23.output

# Aide
help:
	@echo "ğŸ‡«ğŸ‡· COMMANDES COMPILATEUR FRANÃ‡AIS :"
	@echo "===================================="
	@echo "make all              - Compile tout et crÃ©e l'exÃ©cutable"
	@echo "make test-simple      - Test rapide de la grammaire franÃ§aise"
	@echo "make test-mots-cles   - Tests des mots-clÃ©s franÃ§ais"
	@echo "make test-steps       - Tests par Ã©tapes franÃ§ais"
	@echo "make run              - Compile et exÃ©cute le programme franÃ§ais"
	@echo "make test-auto        - Test avec entrÃ©es automatiques"
	@echo "make compare-langues  - Comparaison anglais/franÃ§ais"
	@echo "make analyse-asm      - Analyse du code assembleur"
	@echo "make check-conflicts  - VÃ©rifie les conflits de grammaire"
	@echo "make clean            - Nettoie tous les fichiers"
	@echo "make help             - Affiche cette aide"
	@echo ""
	@echo "ğŸš€ DÃ‰MARRAGE RECOMMANDÃ‰ :"
	@echo "1. make test-simple       # Test de base franÃ§ais"
	@echo "2. make test-mots-cles    # Tests mots-clÃ©s franÃ§ais"  
	@echo "3. make run               # Compilation complÃ¨te franÃ§aise"

.PHONY: all test-simple run test-auto test-mots-cles test-steps compare-langues analyse-asm check-conflicts clean clean-temp help
