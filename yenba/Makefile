# Makefile pour compilateur YEMBA exo20-23
CC = gcc
CFLAGS = -Wall -Wextra -Wno-unused-function
BISON = bison
FLEX = flex
NASM = nasm
LD = ld

# Fichiers source (mÃªmes noms)
YACC_FILE = exo20-23.y
LEX_FILE = exo20-23.lex

# Fichiers gÃ©nÃ©rÃ©s
YACC_C = exo20-23.c
YACC_H = simple.h
LEX_C = exo20-23.yy.c

# ExÃ©cutable
COMPILER = exo20-23

# Cible principale
all: test

# Compilation du compilateur YEMBA
$(COMPILER): $(YACC_FILE) $(LEX_FILE)
	@echo "ðŸ‡¨ðŸ‡² GÃ©nÃ©ration du parser YEMBA avec Bison..."
	$(BISON) --defines=$(YACC_H) -v -o $(YACC_C) $(YACC_FILE)
	@echo "ðŸ” GÃ©nÃ©ration du lexer YEMBA avec Flex..."
	$(FLEX) -o $(LEX_C) $(LEX_FILE)
	@echo "ðŸ”¨ Compilation du compilateur YEMBA..."
	$(CC) $(CFLAGS) $(LEX_C) $(YACC_C) -o $(COMPILER) -lfl
	@echo "âœ… Compilateur YEMBA $(COMPILER) crÃ©Ã©"

# Test simple yemba
test-simple: $(COMPILER)
	@echo "ðŸ§ª Test simple YEMBA..."
	@echo "a = 5; tamba a;" | ./$(COMPILER)
	@if [ -f programme.asm ]; then \
		echo "âœ… Code assembleur gÃ©nÃ©rÃ©"; \
		echo "âš™ï¸  Assemblage..."; \
		$(NASM) -f elf -o test.o programme.asm || exit 1; \
		echo "ðŸ”— Liaison..."; \
		$(LD) -s -o test test.o -melf_i386 -I/lib/ld-linux.so.2 -lc || exit 1; \
		echo "âœ… Test YEMBA rÃ©ussi !"; \
	else \
		echo "âŒ Aucun fichier assembleur gÃ©nÃ©rÃ©"; \
	fi

# GÃ©nÃ©ration du programme assembleur YEMBA
programme.asm: $(COMPILER) commande.mes
	@echo "ðŸ¤– Compilation du programme YEMBA commande.mes..."
	cat commande.mes | ./$(COMPILER)
	@if [ $$? -eq 0 ]; then \
		echo "âœ… Code assembleur YEMBA gÃ©nÃ©rÃ©"; \
	else \
		echo "âŒ Erreur dans la compilation YEMBA"; \
		exit 1; \
	fi

# Assemblage
test.o: programme.asm
	@echo "âš™ï¸  Assemblage avec NASM..."
	$(NASM) -f elf -o test.o programme.asm

# Liaison
test: test.o
	@echo "ðŸ”— Liaison pour crÃ©er l'exÃ©cutable..."
	$(LD) -s -o test test.o -melf_i386 -I/lib/ld-linux.so.2 -lc
	@echo "âœ… ExÃ©cutable 'test' YEMBA crÃ©Ã© avec succÃ¨s"

# Test complet avec exÃ©cution
run: test
	@echo "ðŸƒ ExÃ©cution du programme YEMBA :"
	@echo "================================="
	./test
	@echo "================================="
	@echo "âœ… ExÃ©cution YEMBA terminÃ©e"

# Diagnostic des mots-clÃ©s yemba
test-mots-cles: $(COMPILER)
	@echo "ðŸ‡¨ðŸ‡² Tests des mots-clÃ©s YEMBA :"
	@echo "==============================="
	@echo ""
	@echo "ðŸ§ª 1. Test TAMBA :"
	@echo "a = 5; tamba a;" | ./$(COMPILER)
	@echo ""
	@echo "ðŸ§ª 2. Test NDE-SEDE :"
	@echo "a = 5; nde (a > 3) toh tamba a; sede tamba 0; finit" | ./$(COMPILER)
	@echo ""
	@echo "ðŸ§ª 3. Test MBOMBO :"
	@echo "mbombo i = 1 kesi 3 tamba i; sueh;" | ./$(COMPILER)
	@echo ""
	@echo "ðŸ§ª 4. Test PITEH :"
	@echo "c = 2; piteh (c > 0) ke tamba c; c = c - 1; kelap" | ./$(COMPILER)
	@echo ""
	@echo "ðŸ§ª 5. Test SONTOH :"
	@echo "a = 1; sontoh (a) { ndap 1: tamba 100; kap; kamto: tamba 999; }" | ./$(COMPILER)

# Comparaison multilingue
compare-langues:
	@echo "ðŸŒ COMPARAISON MULTILINGUE :"
	@echo "============================"
	@echo "ANGLAIS     FRANÃ‡AIS     YEMBA"
	@echo "-------     --------     -----"
	@echo "if          si           nde"
	@echo "then        alors        toh"  
	@echo "else        sinon        sede"
	@echo "fi          fsi          finit"
	@echo "for         pour         mbombo"
	@echo "to          jusqua       kesi"
	@echo "next        suivant      sueh"
	@echo "step        pas          tep"
	@echo "while       tantque      piteh"
	@echo "do          faire        ke"
	@echo "done        fait         kelap"
	@echo "switch      selon        sontoh"
	@echo "case        cas          ndap"
	@echo "default     defaut       kamto"
	@echo "break       arreter      kap"
	@echo "print       afficher     tamba"
	@echo "read        lire         nyam"
	@echo ""
	@echo "ðŸŽ¯ Syntaxe YEMBA complÃ¨te supportÃ©e !"

# Test avec entrÃ©es automatiques
test-auto: test
	@echo "ðŸ¤– Test automatique YEMBA avec entrÃ©es prÃ©dÃ©finies..."
	@echo -e "25\n3\n42" | ./test

# Diagnostic des conflits
check-conflicts: $(YACC_FILE)
	@echo "ðŸ” VÃ©rification des conflits de grammaire..."
	$(BISON) --defines=$(YACC_H) -v -o $(YACC_C) $(YACC_FILE)
	@if [ -f exo20-23.output ]; then \
		echo "ðŸ“‹ Analyse des conflits :"; \
		grep -A 5 -B 5 "conflict" exo20-23.output || echo "âœ… Aucun conflit dÃ©tectÃ©"; \
	fi

# Analyse du code assembleur
analyse-asm: programme.asm
	@echo "ðŸ” Analyse du code assembleur gÃ©nÃ©rÃ© :"
	@echo "======================================"
	@echo "ðŸ“Š Structure du programme :"
	@grep -n "section\|global\|_start\|piteh_\|mbombo_\|nde_\|finnde_" programme.asm || echo "Pas de structures complexes"
	@echo ""
	@echo "ðŸ“Š Labels gÃ©nÃ©rÃ©s :"
	@grep -n "^[a-zA-Z_][a-zA-Z0-9_]*:" programme.asm || echo "Pas de labels"

# Tests par Ã©tapes YEMBA
test-steps: $(COMPILER)
	@echo "ðŸ”„ Tests par Ã©tapes YEMBA :"
	@echo "==========================="
	@echo ""
	@echo "ðŸ§ª 1. Test expressions simples :"
	@echo "a = 5; b = 3; tamba a + b;" | ./$(COMPILER)
	@echo ""
	@echo "ðŸ§ª 2. Test NDE simple :"
	@echo "a = 5; nde (a > 3) toh tamba a; finit" | ./$(COMPILER)
	@echo ""
	@echo "ðŸ§ª 3. Test MBOMBO simple :"
	@echo "mbombo i = 1 kesi 3 tamba i; sueh;" | ./$(COMPILER)

# Dictionnaire yemba
dictionnaire:
	@echo "ðŸ“š DICTIONNAIRE YEMBA-FRANÃ‡AIS-ANGLAIS :"
	@echo "========================================"
	@echo ""
	@echo "ðŸ”¤ VERBES D'ACTION :"
	@echo "tamba = afficher = print"
	@echo "nyam  = lire     = read"
	@echo ""
	@echo "ðŸ”€ STRUCTURES DE CONTRÃ”LE :"
	@echo "nde     = si      = if"
	@echo "toh     = alors   = then"
	@echo "sede    = sinon   = else"
	@echo "finit   = fsi     = fi"
	@echo ""
	@echo "ðŸ”„ BOUCLES :"
	@echo "mbombo  = pour    = for"
	@echo "kesi    = jusqua  = to"
	@echo "sueh    = suivant = next"
	@echo "tep     = pas     = step"
	@echo "piteh   = tantque = while"
	@echo "ke      = faire   = do"
	@echo "kelap   = fait    = done"
	@echo ""
	@echo "ðŸ”€ SÃ‰LECTION :"
	@echo "sontoh  = selon   = switch"
	@echo "ndap    = cas     = case"
	@echo "kamto   = defaut  = default"
	@echo "kap     = arreter = break"
	@echo ""
	@echo "ðŸ’¡ Langue yemba : Cameroun occidental"

# Nettoyage
clean:
	@echo "ðŸ§¹ Nettoyage..."
	rm -f $(YACC_C) $(YACC_H) $(LEX_C)
	rm -f exo20-23.output
	rm -f programme.asm test.o test
	rm -f $(COMPILER)

# Nettoyage partiel (garde le compilateur)
clean-temp:
	@echo "ðŸ§¹ Nettoyage temporaire..."
	rm -f programme.asm test.o test
	rm -f exo20-23.output

# Aide
help:
	@echo "ðŸ‡¨ðŸ‡² COMMANDES COMPILATEUR YEMBA :"
	@echo "=================================="
	@echo "make all              - Compile tout et crÃ©e l'exÃ©cutable"
	@echo "make test-simple      - Test rapide de la grammaire yemba"
	@echo "make test-mots-cles   - Tests des mots-clÃ©s yemba"
	@echo "make test-steps       - Tests par Ã©tapes yemba"
	@echo "make run              - Compile et exÃ©cute le programme yemba"
	@echo "make test-auto        - Test avec entrÃ©es automatiques"
	@echo "make compare-langues  - Comparaison multilingue"
	@echo "make dictionnaire     - Dictionnaire yemba-franÃ§ais-anglais"
	@echo "make analyse-asm      - Analyse du code assembleur"
	@echo "make check-conflicts  - VÃ©rifie les conflits de grammaire"
	@echo "make clean            - Nettoie tous les fichiers"
	@echo "make help             - Affiche cette aide"
	@echo ""
	@echo "ðŸš€ DÃ‰MARRAGE RECOMMANDÃ‰ :"
	@echo "1. make test-simple       # Test de base yemba"
	@echo "2. make dictionnaire      # Voir traductions"
	@echo "3. make test-mots-cles    # Tests mots-clÃ©s yemba"  
	@echo "4. make run               # Compilation complÃ¨te yemba"

.PHONY: all test-simple run test-auto test-mots-cles test-steps compare-langues dictionnaire analyse-asm check-conflicts clean clean-temp help
